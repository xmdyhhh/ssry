<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>老师申请</title>
    <th:block th:include="include :: header('老师申请')"/>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>向管理员提交申请</h5>
                </div>
                <div class="ibox-content">
                    <form id="applyForm" class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">选择管理员：</label>
                            <div class="col-sm-8">
                                <select id="adminId" name="adminId" class="form-control" required>
                                    <option value="">== 请选择管理员 ==</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">申请标题：</label>
                            <div class="col-sm-8">
                                <input type="text" name="title" class="form-control" placeholder="请输入申请标题" maxlength="100" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">申请内容：</label>
                            <div class="col-sm-8">
                                <textarea name="content" class="form-control" rows="6" placeholder="请输入申请详情" required></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-8 col-sm-offset-2">
                                <button type="submit" class="btn btn-primary">提交申请</button>
                                <button type="button" class="btn btn-white" onclick="history.back()">返回</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: footer"/>

<script th:inline="javascript">
    // 获取上下文路径
    var ctx = /*[[@{/}]]*/ '';

        $(function () {
            // 1. 加载管理员列表（GET 请求）
            $.get(ctx + "ssry/admin/list")
                .done(function (response) {
                    const $select = $("#adminId");
                    if (response && Array.isArray(response.data)) {
                        response.data.forEach(admin => {
                            // Admin 实体字段：id, username（登录名）, name（真实姓名）
                            $select.append(`<option value="${admin.id}">${admin.name} (${admin.username})</option>`);
                        });
                    } else {
                        layer.msg("未获取到管理员列表", { icon: 2 });
                    }
                })
                .fail(function () {
                    layer.msg("网络错误，无法加载管理员", { icon: 2 });
                });

            // 2. 表单提交（POST 请求）
            $("#applyForm").on("submit", function (e) {
                e.preventDefault();

                const formData = $(this).serialize();
                console.log("提交数据:", formData); // 调试用

                $.ajax({
                    url: ctx + "ssry/message/teacherApply",
                    type: "POST",
                    data: formData,
                    dataType: "json",
                    success: function (res) {
                        if (res && res.code === 0) {
                            layer.msg("申请提交成功！", { icon: 1 }, function () {
                                history.back();
                            });
                        } else {
                            layer.alert(res.msg || "提交失败，请重试", { icon: 2 });
                        }
                    },
                    error: function (xhr) {
                        let msg = "网络异常";
                        if (xhr.responseJSON && xhr.responseJSON.msg) {
                            msg = xhr.responseJSON.msg;
                        }
                        layer.alert(msg, { icon: 2 });
                    }
                });
            });
        });
</script>
</body>
</html>