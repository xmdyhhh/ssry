<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('课程信息列表')"/>
</head>
<body class="gray-bg">
<div class="container-div">
    <div class="row">
        <!-- 搜索区域 -->
        <div class="col-sm-12 search-collapse">
            <form id="formId">
                <div class="select-list">
                    <ul>
                        <li>
                            <label>课程名称：</label>
                            <input type="text" name="courseName"/>
                        </li>
                        <li>
                            <label>教师姓名：</label>
                            <input type="text" name="teacherName"/>
                        </li>
                        <li>
                            <label>学期：</label>
                            <select name="semester">
                                <option value="">全部</option>
                                <option value="春季">春季</option>
                                <option value="秋季">秋季</option>
                            </select>
                        </li>
                        <li>
                            <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()">
                                <i class="fa fa-search"></i>&nbsp;搜索
                            </a>
                            <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()">
                                <i class="fa fa-refresh"></i>&nbsp;重置
                            </a>
                        </li>
                    </ul>
                </div>
            </form>
        </div>

        <!-- 工具栏 -->
        <div class="btn-group-sm" id="toolbar" role="group">
            <!-- 如果需要导出权限 -->
            <a class="btn btn-warning" onclick="$.table.exportExcel()">
                <i class="fa fa-download"></i> 导出
            </a>
        </div>

        <!-- 表格区域 -->
        <div class="col-sm-12 select-table table-striped">
            <table id="bootstrap-table"></table>
        </div>
    </div>
</div>

<!-- 引入公共 footer -->
<th:block th:include="include :: footer"/>
<script th:inline="javascript">
    var prefix = ctx + "ssry/ts";

    $(function () {
        $('#bootstrap-table').bootstrapTable('destroy');

        $('#bootstrap-table').bootstrapTable({
            url: prefix + "/teachercourselist",
            method: 'get',
            pagination: true,
            sidePagination: 'client',
            pageSize: 10,
            pageList: [10, 25, 50],
            search: false,
            showColumns: true,
            clickToSelect: true,
            toolbar: '#toolbar',
            exportDataType: "all",
            exportTypes: ['excel'],
            columns: [
                { checkbox: true },
                { field: 'courseCode',     title: '课程代码',     width: 100 },
                { field: 'courseName',     title: '课程名称',     width: 150 },
                { field: 'credits',        title: '学分',         width: 60 },
                { field: 'semester',       title: '学期',         width: 80 },
                { field: 'teacherName',    title: '任课教师',     width: 100 },
                { field: 'classroom',      title: '上课教室',     width: 100 },
                { field: 'maxEnrollment',  title: '最大容量',     width: 80 },
                { field: 'currentEnrollment', title: '已选人数', width: 80 },
                { field: 'id',             visible: false }, // 注意：row.id 对应的是课程ID
                {
                    title: '操作',
                    align: 'center',
                    formatter: function (value, row) {
                        return `
                            <button class="btn btn-primary btn-xs"
                                    onclick="viewHomework('${row.id}')">
                                <i class="fa fa-eye"></i> 查看作业
                            </button>
                            <button class="btn btn-success btn-xs"
                                    onclick="addHomework('${row.id}', '${row.courseName}')">
                                <i class="fa fa-plus"></i> 添加作业
                            </button>`;
                    }
                }
            ],
            responseHandler: function (res) {
                if (res.code === 0 && Array.isArray(res.data)) {
                    return res.data.map(item => ({
                        ...item,
                        credits: item.credits != null ? item.credits.toString() : ''
                    }));
                } else {
                    layer.msg(res.msg || "数据加载失败");
                    return [];
                }
            }
        });
    });

    function viewHomework(courseId) {
        if (!courseId) {
            layer.msg('课程ID无效', {icon: 2});
            return;
        }
        const url = ctx + "ssry/submission/homeworklist?courseId=" + encodeURIComponent(courseId);
        window.location.href = url;
    }

    function addHomework(courseId, courseName) {
        if (!courseId) {
            layer.msg('课程ID无效', {icon: 2});
            return;
        }

        let formHtml = `
        <form id="addHomeworkForm" style="padding: 20px;">
              <!-- 隐藏字段：courseId -->
        <input type="hidden" name="courseId" value="${courseId}"/>
            <!-- 课程 -->
            <div class="form-group">
                <label>课程：</label>
                <input type="text" name="courseName" class="form-control" readonly value="${courseName}"/>
            </div>

            <!-- 作业标题 -->
            <div class="form-group">
                <label>作业标题：</label>
                <input type="text" name="title" class="form-control" placeholder="请输入作业标题" required/>
            </div>

            <!-- 截止时间 -->
            <div class="form-group">
                <label>截止时间：</label>
                <input type="datetime-local" name="deadline" class="form-control" required/>
            </div>

            <!-- 作业描述 -->
            <div class="form-group">
                <label>作业描述：</label>
                <textarea name="description" class="form-control" rows="3" placeholder="可选"></textarea>
            </div>

            <!-- 格式要求 -->
            <div class="form-group">
                <label>格式要求：</label>
                <input type="text" name="requiredFormat" class="form-control" placeholder="例如：pdf,doc,xlsx" />
            </div>

            <!-- 最大大小（MB） -->
            <div class="form-group">
                <label>最大大小（MB）：</label>
                <input type="number" name="maxSizeMb" class="form-control" placeholder="默认10" min="1" max="100" value="10"/>
            </div>
        </form>`;

        layer.open({
            type: 1,
            title: '添加作业',
            area: ['500px', 'auto'],
            shadeClose: false,
            content: formHtml,
            btn: ['提交', '取消'],
            yes: function (index, layero) {
                const form = layero.find('#addHomeworkForm')[0];
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value.trim(); // 去空格
                });

                // 校验
                if (!data.title) {
                    layer.msg('请输入作业标题');
                    return;
                }
                if (!data.deadline) {
                    layer.msg('请选择截止时间');
                    return;
                }

                // 发送请求
                $.ajax({
                    url: ctx + "ssry/homework/addhomework",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function (res) {
                        if (res.code === 0) {
                            layer.msg('作业添加成功！', {icon: 1});
                            layer.close(index);
                            $('#bootstrap-table').bootstrapTable('refresh');
                        } else {
                            layer.msg(res.msg || '操作失败', {icon: 2});
                        }
                    },
                    error: function () {
                        layer.msg('网络错误，请重试', {icon: 2});
                    }
                });
            }
        });
    }
</script>
</body>
</html>