<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>我的课表</title>
    <!-- 引入必要的 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">

    <style>
        /* 使单元格内容换行 */
        .table .cell {
            white-space: normal;
            word-wrap: break-word;
            height: auto;
            line-height: 1.4;
            padding: 8px;
        }
        .table th {
            text-align: center;
            vertical-align: middle;
        }
        .table td {
            text-align: center;
            vertical-align: top;
        }
    </style>
</head>
<body class="gray-bg">
<div class="container-div">
    <div class="row">
        <div class="col-sm-12 select-table">
            <table id="schedule-table" class="table table-striped"></table>
        </div>
    </div>
</div>

<!-- JS 脚本 -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var ctx = /*[[${#request.contextPath}]]*/ "";
    var prefix = ctx + "/ssry/schedule";
    $(function () {
        loadSchedule();
    });

    function loadSchedule() {
        $.ajax({
            url: prefix + "/teacherschedulelist",
            type: "GET",
            dataType: "json",
            success: function (res) {
                if (res.code === 0 || res.code === 200) {
                    var lessons = [
                        { label: '第1节', start: '08:00', end: '09:40' },
                        { label: '第2节', start: '10:00', end: '11:40' },
                        { label: '第3节', start: '14:00', end: '15:40' },
                        { label: '第4节', start: '16:00', end: '17:40' }
                    ];

                    var days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                    var weekMap = {};
                    days.forEach(day => {
                        weekMap[day] = ['', '', '', ''];
                    });

                    // 中文星期映射
                    var dayMap = { 'Mon': '周一', 'Tue': '周二', 'Wed': '周三', 'Thu': '周四', 'Fri': '周五', 'Sat': '周六', 'Sun': '周日' };

                    res.data.forEach(function (item) {
                        var day = dayMap[item.dayOfWeek] || '周一'; // 英文转中文
                        var timeSlotIndex = -1;

                        // ✅ 精确匹配时间段：比较 startTime 和 endTime
                        for (var i = 0; i < lessons.length; i++) {
                            if (lessons[i].start === item.startTime.slice(0, 5) &&
                                lessons[i].end === item.endTime.slice(0, 5)) {
                                timeSlotIndex = i;
                                break;
                            }
                        }

                        // 如果匹配到时间段，并且该天该节次为空（避免覆盖），则填入
                        if (timeSlotIndex !== -1 && days.includes(day)) {
                            // 防止重复填充同一节课（可选）
                            if (!weekMap[day][timeSlotIndex]) {
                                weekMap[day][timeSlotIndex] = `
                <div class="cell">
                    <strong>${item.courseName}</strong><br>
                    ${item.teacherName}<br>
                    <small>${item.classroom}</small>
                </div>
            `;
                            }
                        } else {
                            console.warn(`未找到匹配时间段: ${item.courseName} (${item.startTime}-${item.endTime})`);
                        }
                    });

                    // 转为表格数据
                    var tableData = lessons.map((lesson, index) => {
                        var row = {
                            period: `${lesson.label}<br><small>${lesson.start}-${lesson.end}</small>`
                        };
                        days.forEach(day => {
                            row[day] = weekMap[day][index] || '';
                        });
                        return row;
                    });

                    // 初始化 Bootstrap Table
                    $('#schedule-table').bootstrapTable('destroy').bootstrapTable({
                        data: tableData,
                        pagination: false,
                        search: false,
                        showColumns: false,
                        clickToSelect: false,
                        columns: [
                            {
                                field: 'period',
                                title: '时间段',
                                width: 120,
                                align: 'center',
                                formatter: function (value) {
                                    return `<div style="text-align:center">${value}</div>`;
                                }
                            },
                            { field: '周一', title: '周一' },
                            { field: '周二', title: '周二' },
                            { field: '周三', title: '周三' },
                            { field: '周四', title: '周四' },
                            { field: '周五', title: '周五' },
                            { field: '周六', title: '周六' },
                            { field: '周日', title: '周日' }
                        ]
                    });
                } else {
                    alert(res.msg || "数据加载失败");
                }
            },
            error: function (xhr, status, err) {
                alert("请求失败：" + err);
                console.error("AJAX Error:", xhr, status, err);
            }
        });
    }
    /*]]>*/
</script>
</body>
</html>