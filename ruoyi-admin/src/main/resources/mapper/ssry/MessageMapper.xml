<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.ssry.mapper.MessageMapper">
    <update id="updateAsRead">
        UPDATE message
        SET is_read = true
        WHERE id=#{id}
          AND is_read = false
    </update>
    <update id="markAllMessagesAsRead">
        UPDATE message
        SET is_read = true
        WHERE receiver_type = #{receiverType}
          AND receiver_id = #{receiverId}
          AND is_read = false
    </update>
    <update id="updateAppStatus">
        UPDATE message
        SET app_status = #{appStatus}
        WHERE id = #{id}
          AND app_status = 'pending'
    </update>
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO message (
        title, content, sender_type, sender_id, sender_name,
        receiver_type, receiver_id, msg_type, is_read, create_time
        ) VALUES
        <foreach collection="list" item="msg" separator=",">
            (#{msg.title}, #{msg.content}, #{msg.senderType}, #{msg.senderId}, #{msg.senderName},
            #{msg.receiverType}, #{msg.receiverId}, #{msg.msgType}, #{msg.isRead}, #{msg.createTime})
        </foreach>
    </insert>
    <select id="selectNoticeByReceiver" resultType="Message">
        SELECT
        id,
        title,
        content,
        sender_type AS senderType,
        sender_id AS senderId,
        receiver_type AS receiverType,
        receiver_id AS receiverId,      <!-- 新增 -->
        sender_name AS senderName,      <!-- 新增 -->
        msg_type AS msgType,
        is_application AS isApplication,
        app_status AS appStatus,
        admin_remark AS adminRemark,
        is_read AS isRead,
        create_time AS createTime
        FROM message
        WHERE receiver_type = #{receiverType}
        AND receiver_id = #{receiverId}
        ORDER BY create_time DESC
    </select>

    <select id="selectById" resultType="com.ruoyi.ssry.domain.Message">
        SELECT
        id,
        title,
        content,
        sender_type AS senderType,
        sender_id AS senderId,
        receiver_type AS receiverType,
        receiver_id AS receiverId,      <!-- 新增 -->
        sender_name AS senderName,      <!-- 新增 -->
        msg_type AS msgType,
        is_application AS isApplication,
        app_status AS appStatus,
        admin_remark AS adminRemark,
        is_read AS isRead,
        create_time AS createTime
        FROM message
        WHERE id = #{id}
    </select>
    <select id="selectadminNoticeByReceiver" resultType="com.ruoyi.ssry.domain.Message">
        SELECT
        id,
        title,
        content,
        sender_type AS senderType,
        sender_id AS senderId,
        receiver_type AS receiverType,
        receiver_id AS receiverId,      <!-- 新增 -->
        sender_name AS senderName,      <!-- 新增 -->
        msg_type AS msgType,
        is_application AS isApplication,
        app_status AS appStatus,
        admin_remark AS adminRemark,
        is_read AS isRead,
        create_time AS createTime
        FROM message
        WHERE receiver_type = #{receiverType}
        AND receiver_id = #{receiverId}
    </select>
    <delete id="removeByIds">
        DELETE FROM message
        WHERE id IN
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>
    <!-- 删除 createTime 早于指定时间的所有消息 -->
    <delete id="deleteMessagesBefore">
        DELETE FROM message
        WHERE create_time &lt; #{createTime}
    </delete>
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO message (
            title, content, sender_type, sender_id, sender_name,
            receiver_type, receiver_id, msg_type, is_application,
            app_status, admin_remark, is_read, create_time
        ) VALUES (
                     #{title}, #{content}, #{senderType}, #{senderId}, #{senderName},
                     #{receiverType}, #{receiverId}, #{msgType}, #{isApplication},
                     #{appStatus}, #{adminRemark}, #{isRead}, #{createTime}
                 )
    </insert>
    <insert id="sendRemider" parameterType="map">
        INSERT INTO message (
            title, content,
            sender_type, sender_id, sender_name,
            receiver_type, receiver_id,
            msg_type, is_application,
            app_status, admin_remark, is_read,
            create_time
        ) VALUES (
                     '提醒', #{content},
                     'teacher', #{senderId}, #{senderName},
                     'student', #{receiverId},
                     'notice', 0,
                     NULL, NULL, 0,
                     NOW()
                 )
    </insert>
</mapper>