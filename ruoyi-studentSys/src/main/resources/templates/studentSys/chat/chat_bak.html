<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天</title>
    <!-- 引入Bootstrap CSS -->
    <!-- 引入Font Awesome -->
    <!-- 引入Google字体 -->

    <th:block th:include="include :: header('聊天')" />

    <link th:href="@{/chat/chat.css}" rel="stylesheet"/>

</head>
<body>
<div class="chat-container">
    <!-- 好友列表 -->
    <div class="friends-list">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="搜索...">
        </div>
        <div class="friends-section">
            <div class="section-title">联系人</div>
            <div class="friends-list-container" id="friendsListContainer">
                <!-- 好友列表将通过JS动态生成 -->
            </div>


            <div class="friend-item active" data-friend="1">
                <div style="position: relative;">
                    <img th:src="@{/avatar/1.jpg}" alt="张三的头像" class="avatar">
                    <span class="avatar-status online"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">张三</div>
                    <div class="last-message">你好！最近怎么样？</div>
                </div>

            </div>
            <div class="friend-item" data-friend="2">
                <div style="position: relative;">
                    <img th:src="@{/avatar/2.jpg}" alt="李四的头像" class="avatar">
                    <span class="avatar-status online"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">李四</div>
                    <div class="last-message">项目进度如何了？</div>
                </div>
                <div class="message-time">昨天</div>
            </div>
            <div class="friend-item" data-friend="3">
                <div style="position: relative;">
                    <img th:src="@{/avatar/3.jpg}" alt="王五的头像" class="avatar">
                    <span class="avatar-status online"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">王五</div>
                    <div class="last-message">周末一起去看电影吗？</div>
                </div>
                <div class="message-time">周三</div>
            </div>
            <div class="friend-item" data-friend="4">
                <div style="position: relative;">
                    <img th:src="@{/avatar/4.jpg}" alt="赵六的头像" class="avatar">
                    <span class="avatar-status online"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">赵六</div>
                    <div class="last-message">好久不见！</div>
                </div>
                <div class="message-time">上周</div>
            </div>
            <div class="friend-item" data-friend="5">
                <div style="position: relative;">
                    <img th:src="@{/avatar/5.jpg}" alt="孙七的头像" class="avatar">
                    <span class="avatar-status online"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">孙七</div>
                    <div class="last-message">下次再约！</div>
                </div>
                <div class="message-time">上月</div>
            </div>
            <div class="friend-item" data-friend="6">
                <div style="position: relative;">
                    <img th:src="@{/avatar/6.jpg}" alt="周八的头像" class="avatar">
                    <span class="avatar-status online"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">周八</div>
                    <div class="last-message">谢谢！</div>
                </div>
                <div class="message-time">上月</div>
            </div>
        </div>
    </div>

    <!-- 聊天窗口 -->
    <div class="chat-window">
        <div class="chat-header">
            <button class="mobile-menu-toggle">
                <i class="fa fa-bars"></i>
            </button>
            <div style="position: relative;">
                <img th:src="@{/avatar/1.jpg}" alt="张三的头像" class="avatar">
                <span class="avatar-status online"></span>
            </div>
            <div class="current-chat-info">
                <div class="current-chat-name">张三</div>
                <div class="current-chat-status">在线</div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn" title="语音通话">
                    <i class="fa fa-phone"></i>
                </button>
                <button class="chat-action-btn" title="视频通话">
                    <i class="fa fa-video-camera"></i>
                </button>
                <button class="chat-action-btn" title="更多选项">
                    <i class="fa fa-ellipsis-v"></i>
                </button>
            </div>
        </div>

        <div class="messages-container">
            <div class="messages" id="messages_div">
                <div class="message in">
                    嗨，你好！最近过得怎么样？
                    <div class="message-time">09:45</div>
                </div>
                <div class="message out">
                    挺好的，谢谢！你呢？
                    <div class="message-time">09:46</div>
                </div>
                <div class="message in">
                    我也不错，最近在忙一个新项目。
                    <div class="message-time">09:47</div>
                </div>
                <div class="message in">
                    你有空的时候我们可以一起吃个饭，聊聊。
                    <div class="message-time">09:48</div>
                </div>
                <div class="message out">
                    好啊，我这周末有空，你看怎么样？
                    <div class="message-time">10:15</div>
                </div>
                <div class="message in">
                    可以，那就周六晚上吧？
                    <div class="message-time">10:23</div>
                </div>
            </div>
        </div>

        <div class="message-input-area">
            <div class="input-container">
                <div class="input-actions">
                    <button class="input-action-btn" title="表情">
                        <i class="fa fa-smile-o"></i>
                    </button>
                    <button class="input-action-btn" title="图片">
                        <i class="fa fa-image"></i>
                    </button>
                    <button class="input-action-btn" title="文件">
                        <i class="fa fa-file"></i>
                    </button>
                </div>
                <textarea class="message-input" placeholder="输入消息..." id="messageInput"></textarea>
                <button class="send-btn" id="sendBtn">
                    <i class="fa fa-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 引入Bootstrap JS和Popper -->
<th:block th:include="include :: footer" />

<script th:inline="javascript">

    // 好友数据
    var friends = {
    };
    friends2 = [[${friends}]];
    // DOM元素
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesContainer = document.querySelector('.messages-container');
    const messagesList = document.getElementById('messages_div');
    const friendItems = document.querySelectorAll('.friend-item');
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const friendsList = document.querySelector('.friends-list');

    // 当前聊天的好友ID
    let currentFriendId = '1';

    // 发送消息
    function sendMessage() {
        const messageText = messageInput.value.trim();
        if (messageText === '') return;

        // 获取当前时间
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        // 创建消息元素
        const messageElement = document.createElement('div');
        messageElement.className = 'message out';
        messageElement.innerHTML = `
                ${messageText}
                <div class="message-time">${timeString}</div>
            `;

        // 添加到消息容器
        messagesList.appendChild(messageElement);

        // 滚动到底部
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 0);

        // 清空输入框
        messageInput.value = '';
        adjustTextareaHeight();

        // 添加到好友消息列表
        friends[currentFriendId].messages.push({
            text: messageText,
            time: timeString,
            type: 'out'
        });
        sendChatMessage(messageText);
        // 更新好友列表中的最后一条消息
        updateFriendLastMessage(currentFriendId, messageText, timeString);

        // 模拟对方回复
        setTimeout(simulateReply, 1500);
    }

    // 模拟对方回复
    function simulateReply() {
        const replies = [
            "好的，我知道了。",
            "嗯，听起来不错。",
            "我稍后回复你可以吗？",
            "这个想法很好！",
            "我明白了，谢谢告知。",
            "我们可以再详细讨论一下这个问题",
            "没问题，就这么定了",
            "我会尽快处理这件事",
            "你觉得什么时候再沟通比较合适？",
            "这个建议很棒，我会考虑的"
        ];

        // 随机选择一个回复
        const randomReply = replies[Math.floor(Math.random() * replies.length)];

        // 获取当前时间
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        // 先显示"正在输入"
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;

        messagesList.appendChild(typingIndicator);

        // 确保滚动到底部显示"正在输入"
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // 一段时间后替换为实际回复
        setTimeout(() => {
            // 移除"正在输入"指示器
            messagesList.removeChild(typingIndicator);

            // 创建回复消息元素
            const messageElement = document.createElement('div');
            messageElement.className = 'message in';
            messageElement.innerHTML = `
                    ${randomReply}
                    <div class="message-time">${timeString}</div>
                `;

            // 添加到消息容器
            messagesList.appendChild(messageElement);

            // 滚动到底部显示新消息
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 0);

            // 添加到好友消息列表
            friends[currentFriendId].messages.push({
                text: randomReply,
                time: timeString,
                type: 'in'
            });

            // 更新好友列表中的最后一条消息
            updateFriendLastMessage(currentFriendId, randomReply, timeString);

        }, 1000);
    }

    // 更新好友列表中的最后一条消息
    function updateFriendLastMessage(friendId, message, time) {
        const friendItem = document.querySelector(`.friend-item[data-friend="${friendId}"]`);
        if (friendItem) {
            friendItem.querySelector('.last-message').textContent = message;
            friendItem.querySelector('.message-time').textContent = time;

            // 如果不是当前聊天的好友，添加未读标记
            if (friendId !== currentFriendId) {
                let unreadCount = friendItem.querySelector('.unread-count');
                if (unreadCount) {
                    unreadCount.textContent = parseInt(unreadCount.textContent) + 1;
                } else {
                    const timeContainer = friendItem.querySelector('.message-time').parentNode;
                    unreadCount = document.createElement('div');
                    unreadCount.className = 'unread-count';
                    unreadCount.textContent = '1';
                    timeContainer.appendChild(unreadCount);
                }
            }
        }
    }

    // 切换聊天对象
    function switchFriend(friendId) {
        currentFriendId = friendId;
        const friend = friends[friendId];

        // 更新聊天窗口头部信息
        document.querySelector('.current-chat-name').textContent = friend.name;
        document.querySelector('.current-chat-status').textContent = friend.statusText;
        document.querySelector('.chat-header .avatar').src = friend.avatar;
        document.querySelector('.chat-header .avatar-status').className = `avatar-status ${friend.status}`;

        // 清空当前消息
        messagesList.innerHTML = '';

        // 添加好友的消息历史
        friend.messages.forEach(msg => {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${msg.type}`;
            messageElement.innerHTML = `
                    ${msg.text}
                    <div class="message-time">${msg.time}</div>
                `;
            messagesList.appendChild(messageElement);
        });

        // 滚动到底部
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 0);

        // 更新好友列表选中状态
        friendItems.forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`.friend-item[data-friend="${friendId}"]`).classList.add('active');

        // 移除未读标记
        const unreadCount = document.querySelector(`.friend-item[data-friend="${friendId}"] .unread-count`);
        if (unreadCount) {
            unreadCount.remove();
        }

        // 在移动设备上切换后隐藏好友列表
        if (window.innerWidth <= 768) {
            friendsList.classList.remove('active');
        }
    }

    // 调整文本框高度
    function adjustTextareaHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (Math.min(messageInput.scrollHeight, 120)) + 'px';
    }

    // 事件监听
    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        adjustTextareaHeight();
    });

    messageInput.addEventListener('input', adjustTextareaHeight);

    friendItems.forEach(item => {
        item.addEventListener('click', () => {
            const friendId = item.getAttribute('data-friend');
            switchFriend(friendId);
        });
    });

    // 移动菜单切换
    mobileMenuToggle.addEventListener('click', () => {
        friendsList.classList.toggle('active');
    });

    // 点击聊天窗口区域关闭移动菜单
    document.querySelector('.chat-window').addEventListener('click', () => {
        if (window.innerWidth <= 768 && friendsList.classList.contains('active')) {
            friendsList.classList.remove('active');
        }
    });

    // 初始化文本框高度
    adjustTextareaHeight();

    // 初始加载时滚动到底部
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 0);




    // 初始化WebSocket连接
    let socket;

    function initWebSocket() {
        // 关闭可能存在的旧连接
        if (socket) {
            socket.close();
        }

        // 建立新连接
        socket = new WebSocket(ctx+'chat');

        // 连接成功
        socket.onopen = function() {
            console.log('聊天连接已建立');
            //showStatusMessage('已连接到聊天服务器');
        };

        // 接收消息
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                // 根据消息类型处理
                if (data.type === 'message') {
                    addMessageToUI(data.content, data.fromName, data.time);
                } else if (data.type === 'online') {
                    showStatusMessage(data.content);
                }
                else if (data.type === 'offline') {
                    showStatusMessage(data.content);
                }
                else if (data.type === 'system') {
                    showStatusMessage(data.content);
                } else if (data.type === 'broadcast') {
                    showStatusMessage(data.content);
                }
                else if (data.type === 'friends') {
                    friends = data.friends;
                    showStatusMessage(data.content);
                }
            } catch (e) {
                console.error('解析消息失败:', e);
            }
        };

        // 连接关闭
        socket.onclose = function(event) {
            console.log('聊天连接已关闭');
            showStatusMessage('与服务器的连接已断开');

            // 5秒后尝试重连
            setTimeout(initWebSocket, 3000);
        };

        // 错误处理
        socket.onerror = function(error) {
            console.error('聊天连接错误:', error);
           showStatusMessage('连接出现错误');
        };
    }

    // 发送聊天消息
    function sendChatMessage(text) {
        if (!text.trim()) return;

        if (socket && socket.readyState === WebSocket.OPEN) {
            const message = {
                type: 'message',
                content: text,
                toName: 'ry'
            };

            // 发送到服务器
            socket.send(JSON.stringify(message));

            // 同时添加到本地UI（优化用户体验）
            addMessageToUI(text, 'user', message.time);
        } else {
            showStatusMessage('连接未建立，无法发送消息');
        }
    }

    // 初始化连接
    initWebSocket();

    function showStatusMessage(msg)
    {
        console.log(msg);
    }
    function addMessageToUI(text, to, time) {
        console.log(text, to, time);
    }


</script>
</body>
</html>
