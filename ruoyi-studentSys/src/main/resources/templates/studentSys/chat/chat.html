<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天</title>
    <!-- 引入Bootstrap CSS -->
    <!-- 引入Font Awesome -->
    <!-- 引入Google字体 -->

    <th:block th:include="include :: header('聊天')" />

    <link th:href="@{/chat/chat.css}" rel="stylesheet"/>

</head>
<body>
<div class="chat-container">
    <!-- 好友列表 -->
    <div class="friends-list">
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="搜索...">
        </div>
        <div class="friends-section">
            <div class="section-title">联系人</div>
            <div class="friends-list-container" id="friendsListContainer">
                <!-- 好友列表将通过JS动态生成 -->
            </div>


            <div th:each="entry : ${friends}" class="friend-item"  th:data-friend="${entry.key}">
                <div style="position: relative;">
                    <img th:src="${entry.value.avatar} "  class="avatar">
                    <span class="avatar-status offline"></span>
                </div>
                <div class="friend-info">
                    <div class="friend-name">[[${entry.value.name}]]</div>
                    <div class="last-message"></div>
                </div>

            </div>


        </div>
    </div>

    <!-- 聊天窗口 -->
    <div class="chat-window">
        <div class="chat-header">
            <button class="mobile-menu-toggle">
                <i class="fa fa-bars"></i>
            </button>
            <div style="position: relative;">
                <img th:src="@{/img/user.png}" class="avatar">
                <span class="avatar-status online"></span>
            </div>
            <div class="current-chat-info">
                <div class="current-chat-name"></div>
                <div class="current-chat-status"></div>
            </div>
            <div class="chat-actions">
                <button class="chat-action-btn" title="语音通话">
                    <i class="fa fa-phone"></i>
                </button>
                <button class="chat-action-btn" title="视频通话">
                    <i class="fa fa-video-camera"></i>
                </button>
                <button class="chat-action-btn" title="更多选项">
                    <i class="fa fa-ellipsis-v"></i>
                </button>
            </div>
        </div>

        <div class="messages-container">
            <div class="messages" id="messages_div">

            </div>
        </div>

        <div class="message-input-area">
            <div class="input-container">
                <div class="input-actions">
                    <button class="input-action-btn" title="表情">
                        <i class="fa fa-smile-o"></i>
                    </button>
                    <button class="input-action-btn" title="图片">
                        <i class="fa fa-image"></i>
                    </button>
                    <button class="input-action-btn" title="文件">
                        <i class="fa fa-file"></i>
                    </button>
                </div>
                <textarea class="message-input" placeholder="输入消息..." id="messageInput"></textarea>
                <button class="send-btn" id="sendBtn">
                    <i class="fa fa-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 引入Bootstrap JS和Popper -->
<th:block th:include="include :: footer" />

<script th:inline="javascript">

    // 好友数据

    var m_friends = [[${friends}]];
    // DOM元素
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesContainer = document.querySelector('.messages-container');
    const messagesList = document.getElementById('messages_div');
    const friendItems = document.querySelectorAll('.friend-item');
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    const friendsList = document.querySelector('.friends-list');

    // 当前聊天的好友ID
    let currentFriendId = '';

    // 发送消息
    function sendMessage() {
        const messageText = messageInput.value.trim();
        if (messageText === '') return;
        if (currentFriendId === '') {
            $.modal.msg("请选择一个好友");

            return;
        }

        // 获取当前时间
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        // 创建消息元素
        const messageElement = document.createElement('div');
        messageElement.className = 'message out';
        messageElement.innerHTML = `
                ${messageText}
                <div class="message-time">${timeString}</div>
            `;

        // 添加到消息容器
        messagesList.appendChild(messageElement);

        // 滚动到底部
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 0);

        // 清空输入框
        messageInput.value = '';
        adjustTextareaHeight();

        // 添加到好友消息列表
        m_friends[currentFriendId].messages.push({
            text: messageText,
            time: timeString,
            type: 'out'
        });
        sendChatMessage(messageText);
        // 更新好友列表中的最后一条消息
        updateFriendLastMessage(currentFriendId, messageText, timeString);

        // 模拟对方回复
       // setTimeout(simulateReply, 1500);
    }


    function recvMessage(msgObj) {

        messageText = msgObj.content;
        if (messageText === '') return;
        time = msgObj.time;
        toName = msgObj.toName;
        fromName = msgObj.fromName;

        // 获取当前时间
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        // 添加到好友消息列表
        m_friends[fromName].messages.push({
            text: messageText,
            time: time,
            type: 'in'
        });

        // 更新好友列表中的最后一条消息
        updateFriendLastMessage(fromName, messageText, time);


        if(fromName != currentFriendId)
        {
            return;
        }


        // 创建消息元素
        const messageElement = document.createElement('div');
        messageElement.className = 'message in';
        messageElement.innerHTML = `
                ${messageText}
                <div class="message-time">${time}</div>
            `;

        // 添加到消息容器
        messagesList.appendChild(messageElement);

        // 滚动到底部
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 0);

        // 清空输入框
        adjustTextareaHeight();



        // 模拟对方回复
       // setTimeout(simulateReply, 1500);
    }




    // 模拟对方回复
    function simulateReply() {
        const replies = [
            "好的，我知道了。",
            "嗯，听起来不错。",
            "我稍后回复你可以吗？",
            "这个想法很好！",
            "我明白了，谢谢告知。",
            "我们可以再详细讨论一下这个问题",
            "没问题，就这么定了",
            "我会尽快处理这件事",
            "你觉得什么时候再沟通比较合适？",
            "这个建议很棒，我会考虑的"
        ];

        // 随机选择一个回复
        const randomReply = replies[Math.floor(Math.random() * replies.length)];

        // 获取当前时间
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const timeString = `${hours}:${minutes}`;

        // 先显示"正在输入"
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;

        messagesList.appendChild(typingIndicator);

        // 确保滚动到底部显示"正在输入"
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // 一段时间后替换为实际回复
        setTimeout(() => {
            // 移除"正在输入"指示器
            messagesList.removeChild(typingIndicator);

            // 创建回复消息元素
            const messageElement = document.createElement('div');
            messageElement.className = 'message in';
            messageElement.innerHTML = `
                    ${randomReply}
                    <div class="message-time">${timeString}</div>
                `;

            // 添加到消息容器
            messagesList.appendChild(messageElement);

            // 滚动到底部显示新消息
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 0);

            // 添加到好友消息列表
            m_friends[currentFriendId].messages.push({
                text: randomReply,
                time: timeString,
                type: 'in'
            });

            // 更新好友列表中的最后一条消息
            updateFriendLastMessage(currentFriendId, randomReply, timeString);

        }, 1000);
    }

    // 更新好友列表中的最后一条消息
    function updateFriendLastMessage(friendId, message, time) {
        const friendItem = document.querySelector(`.friend-item[data-friend="${friendId}"]`);
        if (friendItem) {
            friendItem.querySelector('.last-message').textContent = message;


        }
    }

    // 切换聊天对象
    function switchFriend(friendId) {
        currentFriendId = friendId;
        const friend = m_friends[friendId];

        // 更新聊天窗口头部信息
        document.querySelector('.current-chat-name').textContent = friend.name;
        document.querySelector('.current-chat-status').textContent = friend.statusText;
        document.querySelector('.chat-header .avatar').src = friend.avatar;
        document.querySelector('.chat-header .avatar-status').className = `avatar-status ${friend.status}`;

        // 清空当前消息
        messagesList.innerHTML = '';

        // 添加好友的消息历史
        friend.messages.forEach(msg => {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${msg.type}`;
            messageElement.innerHTML = `
                    ${msg.text}
                    <div class="message-time">${msg.time}</div>
                `;
            messagesList.appendChild(messageElement);
        });

        // 滚动到底部
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 0);

        // 更新好友列表选中状态
        friendItems.forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`.friend-item[data-friend="${friendId}"]`).classList.add('active');

        // 移除未读标记
        const unreadCount = document.querySelector(`.friend-item[data-friend="${friendId}"] .unread-count`);
        if (unreadCount) {
            unreadCount.remove();
        }

        // 在移动设备上切换后隐藏好友列表
        if (window.innerWidth <= 768) {
            friendsList.classList.remove('active');
        }
    }

    // 调整文本框高度
    function adjustTextareaHeight() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (Math.min(messageInput.scrollHeight, 120)) + 'px';
    }

    // 事件监听
    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
        adjustTextareaHeight();
    });

    messageInput.addEventListener('input', adjustTextareaHeight);

    friendItems.forEach(item => {
        item.addEventListener('click', () => {
            const friendId = item.getAttribute('data-friend');
            switchFriend(friendId);
        });
    });

    // 移动菜单切换
    mobileMenuToggle.addEventListener('click', () => {
        friendsList.classList.toggle('active');
    });

    // 点击聊天窗口区域关闭移动菜单
    document.querySelector('.chat-window').addEventListener('click', () => {
        if (window.innerWidth <= 768 && friendsList.classList.contains('active')) {
            friendsList.classList.remove('active');
        }
    });

    // 初始化文本框高度
    adjustTextareaHeight();

    // 初始加载时滚动到底部
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 0);




    // 初始化WebSocket连接
    let socket;

    function initWebSocket() {
        // 关闭可能存在的旧连接
        if (socket) {
            socket.close();
        }

        // 建立新连接
        socket = new WebSocket(ctx+'chat');

        // 连接成功
        socket.onopen = function() {
            console.log('聊天连接已建立');
            //showStatusMessage('已连接到聊天服务器');
        };

        // 接收消息
        socket.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                // 根据消息类型处理
                if (data.type === 'message') {
                    //addMessageToUI(data.content, data.fromName, data.time);
                    recvMessage(data);
                } else if (data.type === 'online') {
                    showStatusMessage(data.content);
                }
                else if (data.type === 'offline') {
                    showStatusMessage(data.content);
                }
                else if (data.type === 'system') {
                    showStatusMessage(data.content);
                    $.modal.msg(data.content);
                } else if (data.type === 'broadcast') {
                    showStatusMessage(data.content);
                }
                else if (data.type === 'friends') {
                    friends = data.friends;
                    showStatusMessage(data.content);
                }
            } catch (e) {
                console.error('解析消息失败:', e);
            }
        };

        // 连接关闭
        socket.onclose = function(event) {
            console.log('聊天连接已关闭');
            showStatusMessage('与服务器的连接已断开');

            // 5秒后尝试重连
            setTimeout(initWebSocket, 3000);
        };

        // 错误处理
        socket.onerror = function(error) {
            console.error('聊天连接错误:', error);
           showStatusMessage('连接出现错误');
        };
    }

    // 发送聊天消息
    function sendChatMessage(text) {
        if (!text.trim()) return;

        if (socket && socket.readyState === WebSocket.OPEN) {
            const message = {
                type: 'message',
                content: text,
                toName: currentFriendId
            };

            // 发送到服务器
            socket.send(JSON.stringify(message));

            // 同时添加到本地UI（优化用户体验）
            addMessageToUI(text, 'user', message.time);
        } else {
            showStatusMessage('连接未建立，无法发送消息');
        }
    }

    // 初始化连接
    initWebSocket();

    function showStatusMessage(msg)
    {
        console.log(msg);
    }
    function addMessageToUI(text, to, time) {
        console.log(text, to, time);
    }


</script>
</body>
</html>
